<!DOCTYPE HTML>
<html>
<head>
<title>Play Wordle</title>
<style type="text/css">
  html {font-family: arial; font-size: 10px; touch-action: none;}
  div {text-align: center; align-content: center; cursor: default; user-select: none;}
  .letter {background-color: lightgray;}
  .letter-correct {background-color: darkgreen; transition: background-color 0.6s;}
  .letter-included {background-color: gold; transition: background-color 0.6s;}
  .letter-excluded {background-color: gray; transition: background-color 0.6s;}
  .message-red {background-color: red; transition: background-color 0.2s;}
  .message-green {background-color: darkgreen; transition: background-color 0.2s;}
  .message-invisible {visibility: hidden;}
</style>
<script src="wordlist.js"></script>
<script>
  // Flag for displaying additional colored div elements which can be used
  // to gauge whether everything is positioned correctly.
  let show_debug = false;
  let debug_width = 0;
  let debug_height = 0;
  const url_index = document.URL.indexOf("?");
  if (url_index != -1)
  {
    const search_params = new URLSearchParams(document.URL.slice(url_index + 1));
    show_debug = search_params.get("show_debug") == "true";
    debug_width = +search_params.get("debug_width");
    debug_height = +search_params.get("debug_height");
  }
  console.log("show_debug = " + show_debug + ", debug_width = " + debug_width + ", debug_height = " + debug_height);

  var ui; // Main UI elements in which both the game and the statistics are shown.
  var st; // State of the game excluding any DOM elements.

  // Game UI elements.
  const letter_elements = Array(6); // Letter elements for each row.
  const solution_letters = Array(5); // One row of letter elements for the solution word.
  var message_elem; // Message element to show texts for the user.
  const keys = new Map(); // Keyboard elements for A-Z, Enter and Backspace.

  function createGameState()
  {
    const old_st = st;
    st = {}
    st.current_row = 0; // The current input row.
    st.current_col = 0; // The current input column.
    st.letter_values = Array(6);  // Letters which have been typed.
    st.letter_classes = Array(6); // CSS classes for each typed letter.
    for (let row = 0; row < 6; ++row)
    {
      st.letter_values[row] = Array(5).fill("");
      st.letter_classes[row] = Array(5).fill("letter");
    }
    st.key_classes = {}; // CSS class for each key id.

    st.message_class = "message-invisible"; // CSS class for the message element.
    st.message_text = ""; // Text for the message element.
    // Generate random solution word.
    st.solution_word = getRandomWordFromList();

    st.found_word = false;  // Whether the correct word has been guessed.
    st.page = "game";       // Either "game" or "statistics".
    st.statistics = old_st ? old_st.statistics : Array(7).fill(0);
  }

  function saveGameStateToLocalStorage()
  {
    window.localStorage.setItem("st", JSON.stringify(st));
  }

  function loadGameStateFromLocalStorage()
  {
    const new_st_json = window.localStorage.getItem("st");
    if (new_st_json)
      st = JSON.parse(new_st_json);
    else
      createGameState();
  }

  function createContainerUI()
  {
    if (ui)
       ui.main_div.remove();
    ui = new ContainerUI();
  }

  class ContainerUI {
    constructor () {
      this.main_div = document.createElement("div");
      document.body.appendChild(this.main_div);

      // Calculate letter and keybord dimensions.
      const width = debug_width  || window.innerWidth;
      const height = debug_height || window.innerHeight;
      this.a = Math.min(width / 5.6, height / 11.8);
      this.w = Math.max(5.6 * this.a, width);
      this.b = this.w / 11.1;
      this.h = 11.8 * this.a;
      this.left_off = 0.5 * Math.max(window.innerWidth - width, 0.);
      this.top_off = 0.5 * Math.max(height - 11.8 * this.a, 0.);

      // Set font size.
      this.letter_font_size = this.a / 2;
      let font_size = this.a / 3.5;
      let main_style = "font-size: " + font_size + "px;";
      if (show_debug)
        main_style += " background-color: red;";
      this.main_div.setAttribute("style", main_style);

      // Use green and blue backgrounds to show the screen and drawing area.
      if (show_debug)
      {
        this.createDiv(0.5 * (window.innerWidth - width), 0, width, height, {"background-color": "green"}, "");
        this.createDiv(this.left_off, this.top_off, this.w, this.h, {"background-color": "blue"}, "");
      }
    }

    // Create a div element and insert it into the main container element.
    createDiv(l, t, w, h, props, inner_text = "", font_size = "")
    {
      const div = document.createElement("div");
      let style =  "position: absolute;";
      { // Add properties to the style string.
        if (props.hasOwnProperty("border-radius"))
          style += " border-radius: " + props["border-radius"] + "px;";
        if (props.hasOwnProperty("background-color"))
          style += " background-color: " + props["background-color"] + ";";
      }
      if (font_size)
        style += " font-size: " + font_size + "px;";
      style += " left: " + l + "px; top: " + t + "px;";
      style += " width: " + w + "px; height: " + h + "px;";
      div.setAttribute("style", style);
      div.innerHTML = inner_text;
      this.main_div.appendChild(div);
      return div;
    }
  }

  // Creates the necessary DOM elements for the game.
  // The state of the game is not modified.
  function initGameElements()
  {
    st.page = "game";
    createContainerUI();
    const {main_div, a, b, w, h, left_off, top_off, letter_font_size} = ui;
    const letter_left_off = left_off + (ui.w - 5.4 * a) / 2;

    // Create a first row with menu elements.
    {
      // Create a button to display the statistics.
      {
        const style = {"background-color" : "lightgray", "border-radius" : 0.3 * a};
        show_statistics_div = ui.createDiv(letter_left_off, top_off + 0.1 * a, 2.6 * a, 0.6 * a, style, "Statistics");
        show_statistics_div.addEventListener("click", showStatistics);
      }

      // Create a button to restart the game.
      {
        const style = {"background-color" : "lightgray", "border-radius" : 0.3 * a};
        const restart_div = ui.createDiv(letter_left_off + 2.8 * a, top_off + 0.1 * a, 2.6 * a, 0.6 * a, style, "Restart");
        restart_div.addEventListener("click", startGame);
      }
    }

    // Create six rows with five letters in each row.
    for (let r = 0; r < 6; r++)
    {
      letter_elements[r] = Array(5);
      for (let c = 0; c < 5; c++)
      {
        const l = letter_left_off + 1.1 * c * a;
        const t = top_off + (0.8 + 1.1 * r) * a;
        const elem = ui.createDiv(l, t, a, a, {}, st.letter_values[r][c], letter_font_size);
        elem.setAttribute("class", st.letter_classes[r][c]);
        letter_elements[r][c] = elem;
      }
    }

    // Create one row with five solution letters.
    for (let c = 0; c < 5; c++)
    {
      const l = letter_left_off + 1.1 * c * a;
      const t = top_off + 7.4 * a;
      const style = show_debug ? {"background-color": "lightgray"} : {};
      const elem = ui.createDiv(l, t, a, a, style, "", letter_font_size);
      solution_letters[c] = elem;
    }

    // Create a message area on top of the solution letters.
    {
      const l = 0.5 * (window.innerWidth - 4.5 * a);
      const t = top_off + 7.6 * a;
      let style = {"border-radius": 0.3 * a};
      message_elem = ui.createDiv(l, t, 4.5 * a, 0.6 * a, style, st.message_text);
      message_elem.setAttribute("class", st.message_class);
    }

    // Create a keyboard with three rows.
    function createKeyBoardRow(row, row_keys)
    {
      let total_key_width = 0.1 * (row_keys.length - 1);
      for (let col = 0; col < row_keys.length; ++col)
        total_key_width += row_keys[col].keyWidth;

      let l = left_off + (w - total_key_width * b) * 0.5;
      for (let col = 0; col < row_keys.length; ++col)
      {
        const key_id = row_keys[col].keyId;
        const t = top_off + (8.5 + 1.1 * row) * a;
        const style = {"border-radius": 0.2 * b};
        const elem = ui.createDiv(l, t, row_keys[col].keyWidth * b, a, style, row_keys[col].keyDisplay);
        let key_class = "letter";
        if (key_id in st.key_classes)
        {
          key_class = st.key_classes[key_id];
        }
        elem.setAttribute("class", key_class);
        l += (row_keys[col].keyWidth + 0.1) * b;
        keys.set(key_id, elem);
        elem.addEventListener("click", (event) => {processKey(key_id);})
      }
    }

    const keys_0 = [{keyId: "Q", keyDisplay: "Q", keyWidth: 1.0},
                    {keyId: "W", keyDisplay: "W", keyWidth: 1.0},
                    {keyId: "E", keyDisplay: "E", keyWidth: 1.0},
                    {keyId: "R", keyDisplay: "R", keyWidth: 1.0},
                    {keyId: "T", keyDisplay: "T", keyWidth: 1.0},
                    {keyId: "Y", keyDisplay: "Y", keyWidth: 1.0},
                    {keyId: "U", keyDisplay: "U", keyWidth: 1.0},
                    {keyId: "I", keyDisplay: "I", keyWidth: 1.0},
                    {keyId: "O", keyDisplay: "O", keyWidth: 1.0},
                    {keyId: "P", keyDisplay: "P", keyWidth: 1.0}];
    const keys_1 = [{keyId: "A", keyDisplay: "A", keyWidth: 1.0},
                    {keyId: "S", keyDisplay: "S", keyWidth: 1.0},
                    {keyId: "D", keyDisplay: "D", keyWidth: 1.0},
                    {keyId: "F", keyDisplay: "F", keyWidth: 1.0},
                    {keyId: "G", keyDisplay: "G", keyWidth: 1.0},
                    {keyId: "H", keyDisplay: "H", keyWidth: 1.0},
                    {keyId: "J", keyDisplay: "J", keyWidth: 1.0},
                    {keyId: "K", keyDisplay: "K", keyWidth: 1.0},
                    {keyId: "L", keyDisplay: "L", keyWidth: 1.0}];
    const keys_2 = [{keyId: "ENTER", keyDisplay: "Enter", keyWidth: 1.55},
                    {keyId: "Z", keyDisplay: "Z", keyWidth: 1.0},
                    {keyId: "X", keyDisplay: "X", keyWidth: 1.0},
                    {keyId: "C", keyDisplay: "C", keyWidth: 1.0},
                    {keyId: "V", keyDisplay: "V", keyWidth: 1.0},
                    {keyId: "B", keyDisplay: "B", keyWidth: 1.0},
                    {keyId: "N", keyDisplay: "N", keyWidth: 1.0},
                    {keyId: "M", keyDisplay: "M", keyWidth: 1.0},
                    {keyId: "BACKSPACE", keyDisplay: "Back", keyWidth: 1.55}];
    createKeyBoardRow(0, keys_0);
    createKeyBoardRow(1, keys_1);
    createKeyBoardRow(2, keys_2);
  }

  // Register event listeners.
  document.addEventListener("DOMContentLoaded", resumeGame);
  document.addEventListener("keydown", processKeyDown);
  window.addEventListener("resize", processResize);

  function resumeGame()
  {
    loadGameStateFromLocalStorage();
    saveGameStateToLocalStorage();
    initGameElements();
    console.log("Solution: " + st.solution_word);
  }

  function startGame()
  {
    createGameState();
    saveGameStateToLocalStorage();
    initGameElements();
    console.log("Solution: " + st.solution_word);
  }

  function processResize()
  {
    if (st.page == "statistics")
      showStatistics()
    else
      initGameElements();
  }

  function processKeyDown(event)
  {
    if (!event.ctrlKey && !event.altKey && !event.metaKey)
      processKey(event.key.toUpperCase());
  }

  function setMessageTextAndClass(new_message_text, new_message_class)
  {
    st.message_class = new_message_class;
    message_elem.className = new_message_class;
    st.message_text = new_message_text;
    message_elem.innerText = new_message_text;
  }

  function processKey(key)
  {
    const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    if (st.found_word || st.current_row >= 6)
    {
      return;
    }
    if (abc.includes(key))
    {
       if (st.current_col < 5)
       {
         st.letter_values[st.current_row][st.current_col] = key;
         letter_elements[st.current_row][st.current_col].innerText = key;
         ++st.current_col;
       }
    }
    else if (key == "BACKSPACE")
    {
      setMessageTextAndClass("", "message-hidden");
      if (st.current_col > 0)
      {
        --st.current_col;
        st.letter_values[st.current_row][st.current_col] = "";
        letter_elements[st.current_row][st.current_col].innerText = "";
      }
    }
    else if (key == "ENTER")
    {
      if (st.current_row < 6 && st.current_col == 5)
      {
        const current_word = getCurrentWord();
        if (!isWordInList(current_word))
        {
          setMessageTextAndClass("Not in word list.", "message-red");
        }
        else
        {
          st.letter_classes[st.current_row] = Array(5).fill("letter-excluded");
          const letter_used = Array(5).fill(false);
          for (let c = 0; c < 5; ++c)
          {
            if (current_word[c] == st.solution_word[c])
            {
              st.letter_classes[st.current_row][c] = "letter-correct";
              letter_used[c] = true;
            }
          }

          for (let c = 0; c < 5; ++c)
          {
            if (st.letter_classes[st.current_row][c] == "letter-correct")
              continue;

            for (let d = 0; d < 5; ++d)
            {
              if (letter_used[d])
                continue;

              if (current_word[c] == st.solution_word[d])
              {
                st.letter_classes[st.current_row][c] = "letter-included";
                letter_used[d] = true;
              }
            }
          }

          for (let c = 0; c < 5; ++c)
          {
            letter_elements[st.current_row][c].className = st.letter_classes[st.current_row][c];

            if (!(current_word[c] in st.key_classes) ||
                st.key_classes[current_word[c]] == "letter-excluded" ||
                st.letter_classes[st.current_row][c] == "letter-correct")
            {
              st.key_classes[current_word[c]] = st.letter_classes[st.current_row][c];
              keys.get(current_word[c]).className = st.letter_classes[st.current_row][c];
            }
          }

          if (current_word == st.solution_word)
          {
            st.found_word = true;
            setMessageTextAndClass(getWinMessage(), "message-green");
            st.statistics[st.current_row] += 1;
          }
          else if (st.current_row == 5)
          {
            for (let c = 0; c < 5; ++c)
            {
              solution_letters[c].innerText = st.solution_word[c];
            }
            st.statistics[st.current_row + 1] += 1;
          }

          ++st.current_row;
          st.current_col = 0;
          saveGameStateToLocalStorage();
        }
      }
    }
  }

  // Produces a random message which is shown when the correct word is found.
  function getWinMessage()
  {
    const win_messages = [
      "Congratulations!", "You guessed it!", "Good job!", "Nice!",
      "You won the game!", "That's the word!", "Solved!"];
    return win_messages[Math.floor(Math.random() * win_messages.length)]
  }

  function getCurrentWord()
  {
    let current_word = "";
    for (let c = 0; c < 5; ++c)
    {
      current_word += letter_elements[st.current_row][c].innerText;
    }
    return current_word;
  }

  function showStatistics()
  {
    console.log("Statistics: " + st.statistics);
    st.page = "statistics";
    createContainerUI();
    const {main_div, a, b, w, h, left_off, top_off, letter_font_size} = ui;
    const letter_left_off = left_off + (ui.w - 5.4 * a) / 2;

    // Create a button to return to the game.
    {
      const style = {"background-color": "lightgray", "border-radius": 0.3  * a};
      const continue_div = ui.createDiv(letter_left_off, top_off + 0.1 * a, 2.6 * a, 0.6 * a, style, "Continue");
      continue_div.addEventListener("click", initGameElements);
    }

    let max_count = 0;
    let num_games_won = 0;
    for (let row = 0; row < 6; ++row)
    {
      max_count = Math.max(max_count, st.statistics[row]);
      num_games_won += st.statistics[row];
    }
    let num_games_lost = st.statistics[6];
    let num_games = num_games_won + num_games_lost;

    ui.createDiv(left_off + 0.1 * a, top_off + 1.2 * a,
              w - 0.2 * a, 0.6 * a, {}, "Game statistics", ui.letter_font_size);
    ui.createDiv(left_off + 0.1 * a, top_off + 2.4 * a,
              w - 0.2 * a, 0.6 * a, {}, "played / won / lost");
    ui.createDiv(left_off + 0.1 * a, top_off + 3.0 * a,
              w - 0.2 * a, 0.6 * a, {}, num_games + " / " + num_games_won + " / " + num_games_lost);

    // Draw bar plot for the guess distribution.
    if (max_count > 0)
    {
      const bar_left_off = 0.5 * (window.innerWidth - 3.9 * a);
      const scale = 0.4 * h  / max_count;
      for (let row = 0; row < 6; ++row)
      {
        const bar_height = scale * st.statistics[row];
        ui.createDiv(bar_left_off + 0.7 * row * a, top_off + h - bar_height - 2 * a,
                  0.4 * a, bar_height, {"background-color": "lightgray"});
        ui.createDiv(bar_left_off + 0.7 * row * a, top_off + h - bar_height - 2.4 * a,
                  0.4 * a, 0.3 * a, {}, st.statistics[row]);
        ui.createDiv(bar_left_off + 0.7 * row * a, top_off + h - 2 * a,
                  0.4 * a, 0.3 * a, {}, row + 1);
        ui.createDiv(0.5 * (window.innerWidth - w), top_off + h - 1.5 * a,
                  w, 0.3 * a, {}, "Guess distribution");
      }
    }
 }

</script>
</head>
<body style="margin: 0px">
</body>
</html>
